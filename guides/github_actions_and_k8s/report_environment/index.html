<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Report Environment # Create an environment in Kosli # The first thing we need to do is creating an environment in Kosli . Kosli Environments is where you'll be reporting the state of your actual environments, like staging or production. You can either create an environment with Kosli CLI ) or via the web UI. We will use the CLI in this guide.
You need a name for your environment - it doesn't have to be the same name you use for the actual environment, but it certainly helps to identify it in the future."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Report Environment"><meta property="og:description" content="Report Environment # Create an environment in Kosli # The first thing we need to do is creating an environment in Kosli . Kosli Environments is where you'll be reporting the state of your actual environments, like staging or production. You can either create an environment with Kosli CLI ) or via the web UI. We will use the CLI in this guide.
You need a name for your environment - it doesn't have to be the same name you use for the actual environment, but it certainly helps to identify it in the future."><meta property="og:type" content="article"><meta property="og:url" content="https://docs.kosli.com/guides/github_actions_and_k8s/report_environment/"><meta property="article:section" content="guides"><title>Report Environment | Kosli developer documentation</title><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=stylesheet href=/book.min.b1d210a50a3e062edc3011f31a381037055eef11a01bd63f8b82456db87b66ea.css integrity="sha256-sdIQpQo+Bi7cMBHzGjgQNwVe7xGgG9Y/i4JFbbh7Zuo=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.eba2f37edb06c44d3a7713b8fea36bec7085295ed77d6f8d450a2b5c357f9b0e.js integrity="sha256-66LzftsGxE06dxO4/qNr7HCFKV7XfW+NRQorXDV/mw4=" crossorigin=anonymous></script>
<script src=https://cdn.usefathom.com/script.js data-site=AUFUAQWT data-excluded-domains=localhost defer></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Kosli developer documentation</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-cecd4ea74d1b57416f3e6afae6030290 class=toggle checked>
<label for=section-cecd4ea74d1b57416f3e6afae6030290 class="flex justify-between"><a href=https://docs.kosli.com/guides/>Guides</a></label><ul><li><input type=checkbox id=section-70f06323c9fc8771b6f6b6608e912f12 class=toggle checked>
<label for=section-70f06323c9fc8771b6f6b6608e912f12 class="flex justify-between"><a href=https://docs.kosli.com/guides/github_actions_and_k8s/>GitHub Actions and k8s</a></label><ul><li><a href=https://docs.kosli.com/guides/github_actions_and_k8s/prerequisites/>Prerequisites</a></li><li><a href=https://docs.kosli.com/guides/github_actions_and_k8s/report_environment/ class=active>Report Environment</a></li><li><a href=https://docs.kosli.com/guides/github_actions_and_k8s/report_artifact/>Report Artifact</a></li><li><a href=https://docs.kosli.com/guides/github_actions_and_k8s/report_deployment/>Report Deployment</a></li></ul></li></ul></li><li><a href=https://docs.kosli.com/installation/>Installing the Kosli CLI</a><ul></ul></li><li><input type=checkbox id=section-90d1aeee0e96e115d1edea3b994d19fb class=toggle>
<label for=section-90d1aeee0e96e115d1edea3b994d19fb class="flex justify-between"><a href=https://docs.kosli.com/tutorials/>Tutorials</a></label><ul><li><a href=https://docs.kosli.com/tutorials/following_a_git_commit_to_runtime_environments/>Following a git commit to runtime environments</a><ul></ul></li><li><a href=https://docs.kosli.com/tutorials/tracing_a_production_incident_back_to_git_commits/>Tracing a production incident back to git commits</a><ul></ul></li><li><a href=https://docs.kosli.com/tutorials/simulating_a_devops_system/>Simulating a DevOps system</a><ul></ul></li></ul></li><li><input type=checkbox id=section-dc8a1c63e6da60163016ce21cae1faa0 class=toggle>
<label for=section-dc8a1c63e6da60163016ce21cae1faa0 class="flex justify-between"><a href=https://docs.kosli.com/concepts/>Concepts</a></label><ul><li><a href=https://docs.kosli.com/concepts/environments/>Environments</a></li><li><a href=https://docs.kosli.com/concepts/pipelines/>Pipelines</a></li></ul></li><li><input type=checkbox id=section-5b53b1ee98ac1dca28aa5705c2335c09 class=toggle>
<label for=section-5b53b1ee98ac1dca28aa5705c2335c09 class="flex justify-between"><a href=https://docs.kosli.com/use_kosli_in_ci_systems/>Use Kosli in CI Systems</a></label><ul><li><a href=https://docs.kosli.com/use_kosli_in_ci_systems/github_actions/>Github Actions</a></li><li><a href=https://docs.kosli.com/use_kosli_in_ci_systems/ci-defaults/>Defaulted Kosli command flags from CI variables</a></li></ul></li><li><input type=checkbox id=section-3993beb65ef7e76a7dbe6e66c07255ac class=toggle>
<label for=section-3993beb65ef7e76a7dbe6e66c07255ac class="flex justify-between"><a href=https://docs.kosli.com/client_reference/>Kosli Commands</a></label><ul><li><a href=https://docs.kosli.com/client_reference/kosli/>kosli</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_approval_get/>kosli approval get</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_approval_ls/>kosli approval ls</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_artifact_get/>kosli artifact get</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_artifact_ls/>kosli artifact ls</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_assert_artifact/>kosli assert artifact</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_assert_bitbucket-pullrequest/>kosli assert bitbucket-pullrequest</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_assert_environment/>kosli assert environment</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_assert_github-pullrequest/>kosli assert github-pullrequest</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_assert_status/>kosli assert status</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_deployment_get/>kosli deployment get</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_deployment_ls/>kosli deployment ls</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_environment_allowedartifacts_add/>kosli environment allowedartifacts add</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_environment_declare/>kosli environment declare</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_environment_diff/>kosli environment diff</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_environment_get/>kosli environment get</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_environment_inspect/>kosli environment inspect</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_environment_log/>kosli environment log</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_environment_ls/>kosli environment ls</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_environment_report_ecs/>kosli environment report ecs</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_environment_report_k8s/>kosli environment report k8s</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_environment_report_lambda/>kosli environment report lambda</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_environment_report_s3/>kosli environment report s3</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_environment_report_server/>kosli environment report server</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_fingerprint/>kosli fingerprint</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_pipeline_approval_assert/>kosli pipeline approval assert</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_pipeline_approval_report/>kosli pipeline approval report</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_pipeline_approval_request/>kosli pipeline approval request</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_pipeline_artifact_report_creation/>kosli pipeline artifact report creation</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_pipeline_artifact_report_evidence_bitbucket-pullrequest/>kosli pipeline artifact report evidence bitbucket-pullrequest</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_pipeline_artifact_report_evidence_generic/>kosli pipeline artifact report evidence generic</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_pipeline_artifact_report_evidence_github-pullrequest/>kosli pipeline artifact report evidence github-pullrequest</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_pipeline_artifact_report_evidence_test/>kosli pipeline artifact report evidence test</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_pipeline_declare/>kosli pipeline declare</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_pipeline_deployment_report/>kosli pipeline deployment report</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_pipeline_inspect/>kosli pipeline inspect</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_pipeline_ls/>kosli pipeline ls</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_status/>kosli status</a></li><li><a href=https://docs.kosli.com/client_reference/kosli_version/>kosli version</a></li></ul></li><li><input type=checkbox id=section-d06928ff9c11121b26f141ced850796c class=toggle>
<label for=section-d06928ff9c11121b26f141ced850796c class="flex justify-between"><a href=https://docs.kosli.com/helm/>Helm</a></label><ul><li><a href=https://docs.kosli.com/helm/helm_chart/>Helm Chart</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Report Environment</strong>
<label for=toc-control></label></div></header><article class=markdown><h1 id=report-environment>Report Environment
<a class=anchor href=#report-environment>#</a></h1><h2 id=create-an-environment-in-kosli>Create an environment in Kosli
<a class=anchor href=#create-an-environment-in-kosli>#</a></h2><p>The first thing we need to do is creating an <strong>environment</strong> in <a href=https://app.kosli.com target=_blank>Kosli
</a>.
Kosli <strong>Environments</strong> is where you'll be reporting the state of your actual environments, like <em>staging</em> or <em>production</em>.
You can either create an environment with <a href=/installation>Kosli CLI
</a>) or via the web UI. We will use the CLI in this guide.</p><p>You need a name for your <strong>environment</strong> - it doesn't have to be the same name you use for the actual environment, but it certainly helps to identify it in the future. In this guide we'll use <strong>github-k8s-test</strong> as the name of the <strong>environment</strong>.
You also need to provide the description of the environment. You'll find this helpful as the number of your environments increases.</p><div class="highlight command"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kosli env declare --name github-k8s-test --environment-type K8S --description <span style=color:#e6db74>&#34;k8s and github actions demo&#34;</span> --api-token &lt;your-api-token&gt; --owner &lt;your-github-username&gt;
</span></span></code></pre></div><h2 id=report-an-environment>Report an environment
<a class=anchor href=#report-an-environment>#</a></h2><p>Time to implement an actual reporting of what's running in your k8s cluster - which means we need to reach out to the cluster and check which docker images were used to run the containers that are currently up in a given namespace.
You can run the <a href=https://docs.kosli.com/client_reference/kosli_environment_report_k8s/ target=_blank>k8s environment report command</a> manually on any machine that can access your k8s cluster, but it is much better to automate the reporting from the start, and we'll use GitHub Actions for that.</p><h3 id=github-workflow>GitHub workflow
<a class=anchor href=#github-workflow>#</a></h3><p>There are a few things you'll need to adjust in the workflow below, so it can work for you:</p><ul><li><code>K8S_CLUSTER_NAME</code> and <code>K8S_GCP_ZONE</code> should refer to your cluster setup and <code>NAMESPACE</code> should refer to a namespace you will to deploy your application to</li><li><code>KOSLI_OWNER</code> is your Kosli username (which will be the same as the GitHub account you used to log into Kosli)</li></ul><p>With these ready you can try to run the following workflow:</p><pre tabindex=0><code>name: Report environment

# You can choose to run the reporting on schedule but for 
# the purpose of setting it up you may also want to be able
# to run it manually, so we added &#39;workflow_dispatch&#39;
on:
  schedule:
    - cron: &#39;*/5 * * * *&#39;
  workflow_dispatch:

env:
  K8S_CLUSTER_NAME: kosli-dev
  K8S_GCP_ZONE: europe-west1
  NAMESPACE: github-k8s-demo
  KOSLI_OWNER: demo
  KOSLI_ENVIRONMENT: github-k8s-test
  KOSLI_CLI_VERSION: &#34;2.0.0&#34;

jobs:
  report-env:
    runs-on: ubuntu-20.04

    steps:

    - name: setup-kosli-cli
      uses: kosli-dev/setup-cli-action@v1
      with:
        version:
          ${{ env.KOSLI_CLI_VERSION }}

    - name: auth
      uses: google-github-actions/auth@v0.4.0
      with:
        credentials_json: ${{ secrets.GCP_K8S_CREDENTIALS }}

    - name: connect-to-k8s
      uses: google-github-actions/get-gke-credentials@main
      with:
        cluster_name: ${{ env.K8S_CLUSTER_NAME }}
        location: ${{ env.K8S_GCP_ZONE }}

    - name: report to Kosli
      env:
        KOSLI_API_TOKEN: ${{ secrets.KOSLI_API_TOKEN }}
      run:
        ./kosli environment report k8s --kubeconfig ${{ env.KUBECONFIG }} -n ${{ env.NAMESPACE }} ${{ env.KOSLI_ENVIRONMENT }}
</code></pre><p>Once the workflow runs successfully, and there is already something running in your cluster, you will see the information about it in <strong>github-k8s-test</strong> environment in Kosli (You'll find it under <strong>Environments</strong> section).<br>If there is nothing running in your cluster we'll build and deploy an artifact in the next step.</p><p>If you had something running in the given namespace, here is what you should see in your <strong>github-k8s-test environment</strong> in Kosli if the pipeline succeeds (triggered either by cron or - if you don't want to wait - manually). The name of the artifact will likely be a different one:</p><p><img src=/images/env-no-provenance.png alt="Incompliant environment, artifact with no provenance"></p><p>Reporting an <strong>environment</strong> is an easy way to get the answer to a question like: "What is running in production?".
So, naturally, the next thing you may want to figure out is: "Is it verified?".</p><p>For now, whatever is running there, will be incompliant since we don't know anything else about the artifact just yet, but reporting your artifacts to Kosli will take us one step further.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){document.querySelectorAll("div.command").forEach(e=>{let t=document.createElement("div"),n=document.createTextNode("Copied!");t.appendChild(n),e.appendChild(t),t.classList.add("copiedText"),e.addEventListener("click",function(){if(navigator.clipboard){let n=e.querySelector("code");navigator.clipboard.writeText(n.innerText),t.classList.add("visible"),setTimeout(()=>{t.classList.remove("visible")},1500)}})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div></main><div class=top-header><div class="container flex"><div class=docs-logo><a href=/><img src=/kosli-docs-logo-white.svg alt="Kosli docs logo"></a></div><div class=separator></div></div></div></body></html>