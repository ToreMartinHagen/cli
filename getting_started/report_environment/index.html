<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Report Environment #  Create an environment in Merkely #  The first thing we need to configure is an environment in Merkely.
Merkely Environment is where you'll be reporting the state of your actual environments, like staging or production.
When you log in to Merkely the Environments page is the first thing you see. If you clicked around before reading this guide you'll find a link to Environments on the left side of the window in Merkely."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Report Environment"><meta property="og:description" content="Report Environment #  Create an environment in Merkely #  The first thing we need to configure is an environment in Merkely.
Merkely Environment is where you'll be reporting the state of your actual environments, like staging or production.
When you log in to Merkely the Environments page is the first thing you see. If you clicked around before reading this guide you'll find a link to Environments on the left side of the window in Merkely."><meta property="og:type" content="article"><meta property="og:url" content="https://docs.merkely.com/getting_started/report_environment/"><meta property="article:section" content="getting_started"><title>Report Environment | Merkely developer documentation</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.a79232456259d3309bc531b08002987657095452ef529a399b1705426c1ddd30.css integrity="sha256-p5IyRWJZ0zCbxTGwgAKYdlcJVFLvUpo5mxcFQmwd3TA=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.75ff34cf7f710157658e30f4da790b5d09c0e520a475dedbe0f00bcc38ff7c6c.js integrity="sha256-df80z39xAVdljjD02nkLXQnA5SCkdd7b4PALzDj/fGw=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Merkely developer documentation</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-acdc30ff5cf57e4ff3a5b04fe43650db class=toggle checked>
<label for=section-acdc30ff5cf57e4ff3a5b04fe43650db class="flex justify-between"><a href=https://docs.merkely.com/getting_started/>Getting Started</a></label><ul><li><a href=https://docs.merkely.com/getting_started/prerequisites/>Prerequisites</a></li><li><a href=https://docs.merkely.com/getting_started/report_environment/ class=active>Report Environment</a></li><li><a href=https://docs.merkely.com/getting_started/report_artifact/>Report Artifact</a></li><li><a href=https://docs.merkely.com/getting_started/report_deployment/>Report Deployment</a></li></ul></li><li><input type=checkbox id=section-dc8a1c63e6da60163016ce21cae1faa0 class=toggle>
<label for=section-dc8a1c63e6da60163016ce21cae1faa0 class="flex justify-between"><a href=https://docs.merkely.com/concepts/>Concepts</a></label><ul><li><a href=https://docs.merkely.com/concepts/devops_change_is_the_new_normal/>DevOps: Change is the New Normal</a></li><li><a href=https://docs.merkely.com/concepts/devops_and_change_management/>DevOps and Change Management</a></li><li><a href=https://docs.merkely.com/concepts/mapping_your_value_stream/>Mapping your value stream</a></li><li><a href=https://docs.merkely.com/concepts/understanding_binary_provenance/>Understanding Binary Provenance</a></li></ul></li><li><input type=checkbox id=section-3993beb65ef7e76a7dbe6e66c07255ac class=toggle>
<label for=section-3993beb65ef7e76a7dbe6e66c07255ac class="flex justify-between"><a href=https://docs.merkely.com/client_reference/>Merkely Commands</a></label><ul><li><a href=https://docs.merkely.com/client_reference/merkely/>merkely</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_assert_bitbucket-pullrequest/>merkely assert bitbucket-pullrequest</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_assert_github-pullrequest/>merkely assert github-pullrequest</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_assert_status/>merkely assert status</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_allowedartifacts_add/>merkely environment allowedartifacts add</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_declare/>merkely environment declare</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_report_ecs/>merkely environment report ecs</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_report_k8s/>merkely environment report k8s</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_report_lambda/>merkely environment report lambda</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_report_s3/>merkely environment report s3</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_report_server/>merkely environment report server</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_fingerprint/>merkely fingerprint</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_approval_assert/>merkely pipeline approval assert</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_approval_report/>merkely pipeline approval report</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_approval_request/>merkely pipeline approval request</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_artifact_report_creation/>merkely pipeline artifact report creation</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_artifact_report_evidence_bitbucket-pullrequest/>merkely pipeline artifact report evidence bitbucket-pullrequest</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_artifact_report_evidence_generic/>merkely pipeline artifact report evidence generic</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_artifact_report_evidence_github-pullrequest/>merkely pipeline artifact report evidence github-pullrequest</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_artifact_report_evidence_test/>merkely pipeline artifact report evidence test</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_declare/>merkely pipeline declare</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_deployment_report/>merkely pipeline deployment report</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_status/>merkely status</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_version/>merkely version</a></li></ul></li><li><input type=checkbox id=section-d06928ff9c11121b26f141ced850796c class=toggle>
<label for=section-d06928ff9c11121b26f141ced850796c class="flex justify-between"><a href=https://docs.merkely.com/helm/>Helm</a></label><ul><li><a href=https://docs.merkely.com/helm/helm_chart/>Helm Chart</a></li></ul></li><li><a href=https://docs.merkely.com/ci-defaults/>Defaulted command flags from CI</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Report Environment</strong>
<label for=toc-control></label></div></header><article class=markdown><h1 id=report-environment>Report Environment
<a class=anchor href=#report-environment>#</a></h1><h2 id=create-an-environment-in-merkely>Create an environment in Merkely
<a class=anchor href=#create-an-environment-in-merkely>#</a></h2><p>The first thing we need to configure is an <strong>environment</strong> in <a href=https://app.merkely.com>Merkely</a>.<br>Merkely <strong>Environment</strong> is where you'll be reporting the state of your actual environments, like <em>staging</em> or <em>production</em>.</p><p>When you log in to Merkely the <strong>Environments</strong> page is the first thing you see. If you clicked around before reading this guide you'll find a link to <strong>Environments</strong> on the left side of the window in Merkely.</p><p>Click the "Add environment" button to create a new Merkely <strong>environment</strong>. On the next page you'll have to select the type - for the purpose of this guide we'll use 'Kubernetes cluster'.</p><p>Next, you need to give your <strong>environment</strong> a name - it doesn't have to be the same name you use for the actual environment, but it certainly helps to identify it in the future. In this guide we'll use <strong>github-k8s-test</strong> as the name of the <strong>environment</strong>.
You also need to provide the description of the environment. You'll find this helpful as the number of your environments increases.</p><p>Click "Save Environment" and you're ready to move on to the next step.</p><h2 id=report-an-environment>Report an environment
<a class=anchor href=#report-an-environment>#</a></h2><p>Time to implement an actual reporting of what's running in your k8s cluster - which means we need to reach out to the cluster and check which docker images were used to run the containers that are currently up in given namespace.</p><h3 id=cli>CLI
<a class=anchor href=#cli>#</a></h3><p>You report the environment using <a href=https://github.com/merkely-development/cli/releases>Merkely CLI tool</a>.<br>You need to download a correct package depending on the architecture of the machine you use to run the CLI.</p><p>You can run the <a href=https://docs.merkely.com/client_reference/merkely_environment_report_k8s/>command</a> manually on any machine that can access your k8s cluster, but it is much better to automate the reporting from the start, and we'll use GitHub Actions for that.</p><h3 id=github-workflow>GitHub workflow
<a class=anchor href=#github-workflow>#</a></h3><p>There is a few things you'll need to adjust in the workflow below, so it can work for you:</p><ul><li><code>K8S_CLUSTER_NAME</code> and <code>K8S_GCP_ZONE</code> should refer to your cluster setup and <code>NAMESPACE</code> should refer to a namespace you will to deploy your application to</li><li><code>MERKELY_OWNER</code> is your Merkely username (wchich will be the same as the GitHub account you used to log into Merkely)</li></ul><p>With these ready you can try to run the following workflow:</p><pre tabindex=0><code>name: Report environment

# You can choose to run the reporting on schedule but for 
# the purpose of setting it up you may also want to be able
# to run it manually, so we added &#39;workflow_dispatch&#39;
on:
  schedule:
    - cron: &#39;*/5 * * * *&#39;
  workflow_dispatch:

env:
  K8S_CLUSTER_NAME: merkely-dev
  K8S_GCP_ZONE: europe-west1
  NAMESPACE: github-k8s-demo
  MERKELY_OWNER: demo
  MERKELY_ENVIRONMENT: github-k8s-test
  MERKELY_CLI_VERSION: &#34;1.5.0&#34;

jobs:
  report-env:
    runs-on: ubuntu-20.04

    steps:

    - name: Download Merkely cli client
      id: download-merkely-cli
      run: |
        wget https://github.com/merkely-development/cli/releases/download/v${{ env.MERKELY_CLI_VERSION }}/merkely_${{ env.MERKELY_CLI_VERSION }}_linux_amd64.tar.gz
        tar -xf merkely_${{ env.MERKELY_CLI_VERSION }}_linux_amd64.tar.gz merkely

    - name: auth
      uses: google-github-actions/auth@v0.4.0
      with:
        credentials_json: ${{ secrets.GCP_K8S_CREDENTIALS }}

    - name: connect-to-k8s
      uses: google-github-actions/get-gke-credentials@main
      with:
        cluster_name: ${{ env.K8S_CLUSTER_NAME }}
        location: ${{ env.K8S_GCP_ZONE }}

    - name: report to Merkely
      env:
        MERKELY_API_TOKEN: ${{ secrets.MERKELY_API_TOKEN }}
      run:
        ./merkely environment report k8s --kubeconfig ${{ env.KUBECONFIG }} -n ${{ env.NAMESPACE }} ${{ env.MERKELY_ENVIRONMENT }}
</code></pre><p>Once the workflow runs successfully, and there is already something running in your cluster, you will see the information about it in <strong>github-k8s-test</strong> environment in Merkely (You'll find it under <strong>Environments</strong> section).<br>If there is nothing running in your cluster we'll build and deploy an artifact in the next step.</p><p>If you had something running in given namespace, here is what you should see in your <strong>github-k8s-test environment</strong> in Merkely if the pipeline succeedes (triggered either by cron or - if you don't want to wait - manually). The name of the artifact will likely be a different one:</p><p><img src=/images/env-no-provenance.png alt="Incompliant environment, artifact with no provenance"></p><p>Reporting an <strong>environment</strong> is an easy way to get the answer to a question like: "What is running in production?".
So, naturally, the next thing you may want to figure out is: "Is it verified?".</p><p>For now, whatever is running there, will be incompliant since we don't know anything else about the artifact just yet, but reporting your artifacts to Merkely will take us one step further.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div></main><div class=top-header><div class="container flex"><div class=docs-logo><a href=/><img src=/merkely-docs-logo-white.svg alt="Merkely docs logo"></a></div><div class=separator></div><div class=back-to-site><a href=https://www.merkely.com target=_blank><span class=left-carret>&lt;</span> Back to Website</a></div></div></div></body></html>