<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Report Artifact #  Every time you build an artifact - in our case a Docker image - you can store (and easily access) all the information you have about it in Merkely. We call it reporting an artifact.
Artifacts in Merkely are reported to Merkely Pipelines. You can find the Pipelines section just below Environments.
Create a pipeline #  To report an artifact from your GitHub workflow you need to create a Merkely pipeline first."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Report Artifact"><meta property="og:description" content="Report Artifact #  Every time you build an artifact - in our case a Docker image - you can store (and easily access) all the information you have about it in Merkely. We call it reporting an artifact.
Artifacts in Merkely are reported to Merkely Pipelines. You can find the Pipelines section just below Environments.
Create a pipeline #  To report an artifact from your GitHub workflow you need to create a Merkely pipeline first."><meta property="og:type" content="article"><meta property="og:url" content="https://docs.merkely.com/getting_started/report_artifact/"><meta property="article:section" content="getting_started"><title>Report Artifact | Merkely developer documentation</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.a79232456259d3309bc531b08002987657095452ef529a399b1705426c1ddd30.css integrity="sha256-p5IyRWJZ0zCbxTGwgAKYdlcJVFLvUpo5mxcFQmwd3TA=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.57a49f4c4b327a53230f7c9b1ec3cf352212085e287d02125f7c683c41f6e890.js integrity="sha256-V6SfTEsyelMjD3ybHsPPNSISCF4ofQISX3xoPEH26JA=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Merkely developer documentation</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-acdc30ff5cf57e4ff3a5b04fe43650db class=toggle checked>
<label for=section-acdc30ff5cf57e4ff3a5b04fe43650db class="flex justify-between"><a href=https://docs.merkely.com/getting_started/>Getting Started</a></label><ul><li><a href=https://docs.merkely.com/getting_started/prerequisites/>Prerequisites</a></li><li><a href=https://docs.merkely.com/getting_started/report_environment/>Report Environment</a></li><li><a href=https://docs.merkely.com/getting_started/report_artifact/ class=active>Report Artifact</a></li><li><a href=https://docs.merkely.com/getting_started/report_deployment/>Report Deployment</a></li></ul></li><li><input type=checkbox id=section-dc8a1c63e6da60163016ce21cae1faa0 class=toggle>
<label for=section-dc8a1c63e6da60163016ce21cae1faa0 class="flex justify-between"><a href=https://docs.merkely.com/concepts/>Concepts</a></label><ul><li><a href=https://docs.merkely.com/concepts/devops_change_is_the_new_normal/>DevOps: Change is the New Normal</a></li><li><a href=https://docs.merkely.com/concepts/devops_and_change_management/>DevOps and Change Management</a></li><li><a href=https://docs.merkely.com/concepts/mapping_your_value_stream/>Mapping your value stream</a></li><li><a href=https://docs.merkely.com/concepts/understanding_binary_provenance/>Understanding Binary Provenance</a></li></ul></li><li><input type=checkbox id=section-3993beb65ef7e76a7dbe6e66c07255ac class=toggle>
<label for=section-3993beb65ef7e76a7dbe6e66c07255ac class="flex justify-between"><a href=https://docs.merkely.com/client_reference/>Merkely Commands</a></label><ul><li><a href=https://docs.merkely.com/client_reference/merkely/>merkely</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_assert_bitbucket-pullrequest/>merkely assert bitbucket-pullrequest</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_assert_github-pullrequest/>merkely assert github-pullrequest</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_assert_status/>merkely assert status</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_allowedartifacts_add/>merkely environment allowedartifacts add</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_declare/>merkely environment declare</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_report_ecs/>merkely environment report ecs</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_report_k8s/>merkely environment report k8s</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_report_lambda/>merkely environment report lambda</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_report_s3/>merkely environment report s3</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_environment_report_server/>merkely environment report server</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_fingerprint/>merkely fingerprint</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_approval_assert/>merkely pipeline approval assert</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_approval_report/>merkely pipeline approval report</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_approval_request/>merkely pipeline approval request</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_artifact_report_creation/>merkely pipeline artifact report creation</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_artifact_report_evidence_bitbucket-pullrequest/>merkely pipeline artifact report evidence bitbucket-pullrequest</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_artifact_report_evidence_generic/>merkely pipeline artifact report evidence generic</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_artifact_report_evidence_github-pullrequest/>merkely pipeline artifact report evidence github-pullrequest</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_artifact_report_evidence_test/>merkely pipeline artifact report evidence test</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_declare/>merkely pipeline declare</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_pipeline_deployment_report/>merkely pipeline deployment report</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_status/>merkely status</a></li><li><a href=https://docs.merkely.com/client_reference/merkely_version/>merkely version</a></li></ul></li><li><input type=checkbox id=section-d06928ff9c11121b26f141ced850796c class=toggle>
<label for=section-d06928ff9c11121b26f141ced850796c class="flex justify-between"><a href=https://docs.merkely.com/helm/>Helm</a></label><ul><li><a href=https://docs.merkely.com/helm/helm_chart/>Helm Chart</a></li></ul></li><li><a href=https://docs.merkely.com/ci-defaults/>Defaulted command flags from CI</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Report Artifact</strong>
<label for=toc-control></label></div></header><article class=markdown><h1 id=report-artifact>Report Artifact
<a class=anchor href=#report-artifact>#</a></h1><p>Every time you build an <strong>artifact</strong> - in our case a Docker image - you can store (and easily access) all the information you have about it in Merkely. We call it <em>reporting an <strong>artifact</strong></em>.</p><p>Artifacts in Merkely are reported to Merkely <strong>Pipelines</strong>. You can find the <strong>Pipelines</strong> section just below <strong>Environments</strong>.</p><h2 id=create-a-pipeline>Create a pipeline
<a class=anchor href=#create-a-pipeline>#</a></h2><p>To report an <strong>artifact</strong> from your GitHub workflow you need to create a Merkely <strong>pipeline</strong> first. Every time your workflow builds a new version of Docker image it will be reported to the same Merkely <strong>pipeline</strong>.<br>Merkely <strong>pipeline</strong> has to exist before you can start reporting <strong>artifacts</strong> to it, and you can make the creation of a <strong>pipeline</strong> a part of the build workflow. (It's safe - rerunning <strong>pipeline</strong> creation command won't erase existing entries.)<br>In this guide we're creating a Merkely <strong>pipeline</strong> called <strong>github-k8s-demo</strong> and that's the name you'll see in the code.</p><p>As it was in the case of reporting environment, we need to download Merkely CLI in the workflow, to be able to run the commands.</p><h2 id=report-an-artifact>Report an artifact
<a class=anchor href=#report-an-artifact>#</a></h2><p>Here is a complete workflow that takes care of CLI download, <strong>pipeline</strong> creation and docker image build and reports it to the Merkely <strong>pipeline</strong>.</p><p>Remember:</p><ul><li><code>K8S_CLUSTER_NAME</code>, <code>K8S_GCP_ZONE</code> and <code>NAMESPACE</code> should be the same you used in <strong>Report Environment</strong> step</li><li><code>IMAGE</code> should contain your dockerhub username (instead of our colleague's Ewelina username). You also need to use the correct username in <em>Login to hub.docker.com</em> step</li><li><code>MERKELY_OWNER</code> should be the same your Merkely username.</li></ul><p>In the workflow you'll find comments about specific parts of it.</p><pre tabindex=0><code>name: Build and Deploy

on:
  push:


env: 
  # gke k8s cluster variables
  K8S_CLUSTER_NAME: merkely-dev
  K8S_GCP_ZONE: europe-west1
  NAMESPACE: github-k8s-demo
  # name of the docker image to build, replace with the name 
  # that will contain your dockerhub id
  IMAGE: ewelinawilkosz/github-k8s-demo
  # merkely variables - will be picked up by commands
  MERKELY_OWNER: demo
  MERKELY_PIPELINE: github-k8s-demo
  MERKELY_ENVIRONMENT: github-k8s-test
  MERKELY_CLI_VERSION: &#34;1.5.0&#34;

jobs:
  build-report:
    runs-on: ubuntu-20.04

    # outputs to be passed on to &#39;deploy&#39; job below
    outputs:
      tag: ${{ steps.prep.outputs.tag }}
      tagged-image: ${{ steps.prep.outputs.tagged-image }}
      image-digest: ${{ steps.digest-prep.outputs.image-digest }}

    steps:
    # checkout code
    - uses: actions/checkout@v2
      with:
        fetch-depth: 1

    - name: Prepare
      id: prep
      run: |
        TAG=$(echo $GITHUB_SHA | head -c7)
        TAGGED_IMAGE=${{ env.IMAGE }}:${TAG}
        echo &#34;TAG=${TAG}&#34; &gt;&gt; ${GITHUB_ENV}
        echo &#34;TAGGED_IMAGE=${TAGGED_IMAGE}&#34; &gt;&gt; ${GITHUB_ENV}
        echo ::set-output name=tag::${TAG}
        echo ::set-output name=tagged-image::${TAGGED_IMAGE}
  
    # This is the a separate action that sets up buildx (buildkit) runner
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    # use your own username and cofigured token to log into dockerhub
    - name: Login to hub.docker.com
      uses: docker/login-action@v1
      with:
        username: ewelinawilkosz
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push Docker image
      id: docker_build
      uses: docker/build-push-action@v2
      with:
        push: true
        tags: ${{ env.TAGGED_IMAGE }}
        no-cache: true

    # the digest will be passed to merkely commands using &#39;sha256&#39; flags
    - name: Make the image digest available for following steps
      id: digest-prep
      run: |
        ARTIFACT_SHA=$( echo ${{ steps.docker_build.outputs.digest }} | sed &#39;s/.*://&#39;)
        echo &#34;DIGEST=$ARTIFACT_SHA&#34; &gt;&gt; ${GITHUB_ENV}
        echo ::set-output name=image-digest::${ARTIFACT_SHA}

    - name: Download Merkely cli client
      id: download-merkely-cli
      run: |
        wget https://github.com/merkely-development/cli/releases/download/v${{ env.MERKELY_CLI_VERSION }}/merkely_${{ env.MERKELY_CLI_VERSION }}_linux_amd64.tar.gz
        tar -xf merkely_${{ env.MERKELY_CLI_VERSION }}_linux_amd64.tar.gz merkely  

    - name: Declare pipeline in Merkely
      env:
        MERKELY_API_TOKEN: ${{ secrets.MERKELY_API_TOKEN }}
      run: 
        ./merkely pipeline declare 
          --description &#34;Merkely server&#34; 
          --pipeline ${{ env.MERKELY_PIPELINE }} 
          --template &#34;artifact&#34;

    - name: Report Docker image in Merkely
      env:
        MERKELY_API_TOKEN: ${{ secrets.MERKELY_API_TOKEN }}
      run: 
        ./merkely pipeline artifact report creation ${{ env.TAGGED_IMAGE }}
          --sha256 ${{ env.DIGEST }}

  # deploy review environment
  deploy:
    needs: [build-report]
    runs-on: ubuntu-20.04

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 1

    - id: auth
      uses: google-github-actions/auth@v0.4.0
      with:
        credentials_json: ${{ secrets.GCP_K8S_CREDENTIALS }}

    - id: connect-to-k8s
      uses: google-github-actions/get-gke-credentials@main
      with:
        cluster_name: ${{ env.K8S_CLUSTER_NAME }}
        location: ${{ env.K8S_GCP_ZONE }}

    - uses: azure/setup-kubectl@v1
      id: install-kubectl
      
    # The KUBECONFIG env var is automatically exported and picked up by kubectl.
    - name: Ensure review env namespace
      run: |
        kubectl get namespace ${{ env.NAMESPACE }} || kubectl create namespace ${{ env.NAMESPACE }}
    
    - name: Deploy
      run: |
        sed -i &#39;s/TAG/${{ needs.build-report.outputs.tag }}/g&#39; k8s/deployment.yaml
        kubectl apply -f k8s/deployment.yaml -n ${{ env.NAMESPACE }}
</code></pre><p>Once the workflow runs succesfully, you should see it reported in Merkely <strong>github-k8s-demo pipeline</strong>:</p><p><img src=/images/artifact-list.png alt="Compliant artifact with no deployments"></p><p>With more details once you click on it:</p><p><img src=/images/artifact-no-deployment.png alt="Compliant artifact with no deployments"></p><p>You will also notice a change in the state of your <strong>github-k8s-test</strong> environment (if the environment reporting workflow run successfully): it is still incompliant, but now the artifact running there has provenance (you can see the name of Merkely <strong>pipeline: github-k8s-demo</strong> that the artifact was reported to, in a grey, pill shaped field) so we can check how it was build:</p><p><img src=/images/env-provenance.png alt="Incompliant environment, artifact with provenance"></p><p>Now that your aritfact reporting works the only thing missing part is reporting the deployment.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div></main><div class=top-header><div class="container flex"><div class=docs-logo><a href=/><img src=/merkely-docs-logo-white.svg alt="Merkely docs logo"></a></div><div class=separator></div><div class=back-to-site><a href=https://www.merkely.com target=_blank><span class=left-carret>&lt;</span> Back to Website</a></div></div></div></body></html>